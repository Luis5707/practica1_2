// Agregado: AreaRecreativa_Clima
//TODO-- Falta filtrar la salida, solo mostrar TIPO_INCIDENTE, GRAVEDAD, y FECHA_REPORTE de IncidentesSeguridad, 
db.areaRecreativa.aggregate([
    {
        $lookup: {
            from: "juego",
            localField: "NDP", // Modifica esto si es necesario
            foreignField: "NDP",
            as: "juegos"
        } 
    },
    {
        $lookup: {
            from: "incidenteSeguridad",
            localField: "ID", // Asegúrate de que este campo sea correcto
            foreignField: "AREA_RECREATIVA_ID",
            as: "incidentes"
        }
    },
    {
        $lookup: {
            from: "meteo",
            localField: "COD_BARRIO", // Asegúrate de que este campo sea correcto
            foreignField: "DISTRITO",
            as: "clima"
        }
    },
    {
        $addFields: {
            estadoGlobalArea: {
                   $add: [
                    {
                        $size: {
                            $filter: {
                                input: "$juegos",
                                as: "juego",
                                cond: { $eq: ["$$juego.ESTADO", false] } // Cambia esto si el campo es diferente
                            }
                        }
                    },
                    { $size: "$incidentes" }
                ]
            }
        }
    },
    {
        $project: {
            ID: 1,
            estadoGlobalArea: 1,
            juegos: 1,
            incidentes: 1,
            clima: 1
        }
    }
])
